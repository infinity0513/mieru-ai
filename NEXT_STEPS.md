# 今後の実装・運用フロー

## 📋 現在の実装状況

### ✅ 完了している項目

1. **バックエンドAPI実装**
   - `/api/meta/insights` - ユーザーごとのMetaアカウント情報を使用してInsightsを取得
   - `/api/users/me/meta-settings` - Metaアカウント情報の取得・更新
   - NaN値の処理を実装済み

2. **フロントエンド実装**
   - 設定画面にMetaアカウント情報入力フォーム実装済み
   - ユーザーごとの設定を保存・取得可能

3. **ドキュメント**
   - `N8N_WORKFLOW_UPDATE_GUIDE.md` - n8nワークフロー更新手順
   - `N8N_WORKFLOW_CREATION_GUIDE.md` - n8nワークフロー作成手順

---

## 🎯 次のステップ（優先順位順）

### ステップ1: ユーザーがMetaアカウント情報を設定

**実施者**: 各ユーザー

**手順**:
1. 本システムの設定画面にアクセス
2. 「Meta広告アカウント連携」セクションで以下を入力：
   - **Meta広告アカウントID**: `act_123456789`（Meta広告マネージャーで確認）
   - **Metaアクセストークン**: 長期トークン（60日有効）を推奨
3. 「Meta設定を保存」をクリック

**確認事項**:
- 設定が正しく保存されているか
- エラーメッセージが表示されないか

---

### ステップ2: n8nワークフローの更新

**実施者**: システム管理者

**手順**:
1. n8nダッシュボードにアクセス
2. 既存のワークフローを開く
3. `N8N_WORKFLOW_UPDATE_GUIDE.md` に従ってワークフローを更新：
   - Facebook Graph APIノードを削除
   - HTTP Request（ログイン）を追加
   - HTTP Request（Meta Insights取得）を追加
   - Code in JavaScript（データ変換）を修正

**確認事項**:
- ワークフローが正しく実行されるか
- エラーが発生しないか

---

### ステップ3: テスト実行

**実施者**: システム管理者

**手順**:
1. n8nワークフローを手動実行
2. 各ステップでエラーが発生しないか確認
3. 本システムにデータが正しくアップロードされるか確認

**確認事項**:
- ログインが成功するか
- Meta Insightsが正しく取得できるか
- データ変換が正しく行われるか
- CSVアップロードが成功するか

---

### ステップ4: エラーハンドリングの確認・改善

**実施者**: 開発者

**確認項目**:
1. **Meta APIエラーの処理**
   - トークンの有効期限切れ
   - アカウントIDの不正
   - APIレート制限

2. **データ処理エラー**
   - NaN値の処理
   - 空データの処理
   - データ型の変換エラー

3. **ユーザーへのエラーメッセージ**
   - 分かりやすいエラーメッセージの表示
   - エラー解決方法の案内

---

### ステップ5: 本番環境での動作確認

**実施者**: システム管理者

**確認項目**:
1. スケジュール実行が正しく動作するか
2. 複数ユーザーが同時に使用しても問題ないか
3. パフォーマンスに問題がないか

---

## 🔧 トラブルシューティング

### よくある問題と解決方法

#### 1. Meta APIエラー: "Invalid access token"
**原因**: アクセストークンの有効期限切れ
**解決方法**: 
- 設定画面で新しい長期トークンを取得して更新
- 長期トークンの取得方法は `META_ACCOUNT_ID_GUIDE.md` を参照

#### 2. Meta APIエラー: "Invalid account ID"
**原因**: アカウントIDの形式が正しくない
**解決方法**: 
- アカウントIDが `act_` で始まっているか確認
- Meta広告マネージャーで正しいアカウントIDを確認

#### 3. n8nワークフローエラー: "Login failed"
**原因**: ログイン情報が正しくない
**解決方法**: 
- n8nワークフローのログイン情報を確認
- 本システムのユーザーアカウントが有効か確認

#### 4. データがアップロードされない
**原因**: データ変換エラーまたはアップロードエラー
**解決方法**: 
- n8nワークフローの各ステップでエラーを確認
- Code in JavaScriptノードのログを確認

---

## 📚 参考ドキュメント

- `N8N_WORKFLOW_UPDATE_GUIDE.md` - n8nワークフロー更新手順
- `N8N_WORKFLOW_CREATION_GUIDE.md` - n8nワークフロー作成手順
- `META_ACCOUNT_ID_GUIDE.md` - MetaアカウントIDとトークンの取得方法
- `N8N_RAILWAY_SETUP.md` - n8nのRailwayセットアップ手順

---

## ⚠️ 注意事項

1. **セキュリティ**
   - Metaアクセストークンは機密情報です。適切に管理してください
   - トークンは定期的に更新することを推奨します

2. **APIレート制限**
   - Meta APIにはレート制限があります
   - 大量のデータを取得する場合は、適切な間隔を空けてください

3. **データの整合性**
   - データ取得時にエラーが発生した場合、データが不完全になる可能性があります
   - 定期的にデータの整合性を確認してください

---

## 🎉 完了条件

以下の条件をすべて満たした場合、実装は完了とみなします：

- [ ] すべてのユーザーがMetaアカウント情報を設定済み
- [ ] n8nワークフローが正しく更新され、動作確認済み
- [ ] テスト実行が成功し、データが正しくアップロードされる
- [ ] エラーハンドリングが適切に実装されている
- [ ] 本番環境での動作確認が完了している

