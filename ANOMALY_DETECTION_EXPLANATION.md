# 異常検知ロジックの説明

## 検知方法について

### ❌ 「日単体で異常を検知」ではありません
### ✅ 「過去N日間の平均と比較して異常を検知」です

現在の実装では、各日について以下の方法で異常を検知しています：

1. **過去5日間（windowSize）の平均値を計算**
   - 例：12月18日を検知する場合、12月13日～17日の平均CPAを計算

2. **その日の値と平均値を比較**
   - CPA Spike: その日のCPA > 平均CPA × 1.5（1.5倍以上）
   - ROAS Drop: その日のROAS < 平均ROAS × 0.7（0.7倍以下）

3. **異常として検知**
   - 条件を満たした場合、その日を異常として検知

### 例：12月18日の検知

```
過去5日間（12月13日～17日）の平均CPAを計算
↓
12月18日のCPA（¥2,000）が平均の1.5倍以上かチェック
↓
「+83% vs 5日平均」= 12月18日のCPAが過去5日平均の183%（1.83倍）
```

### 12月16日、17日、18日が連続して検知された理由

各日について、それぞれ過去5日間の平均と比較して検知しているため：
- **12月16日**: 過去5日間（12月11日～15日）の平均と比較
- **12月17日**: 過去5日間（12月12日～16日）の平均と比較
- **12月18日**: 過去5日間（12月13日～17日）の平均と比較

連続して検知されたということは、この期間にCPAが継続的に高かったことを示しています。

## 数値検証

### 12月18日のデータ（AI診断から）

- **Cost**: ¥50,000
- **Conversions**: 25
- **CPA**: ¥50,000 ÷ 25 = **¥2,000** ✓
- **Impressions**: 15,000
- **Clicks**: 450
- **CTR**: (450 ÷ 15,000) × 100 = **3.00%** ✓
- **CPC**: ¥50,000 ÷ 450 = **¥111** ✓
- **CVR**: (25 ÷ 450) × 100 = **5.56%** ✓
- **ROAS**: 250% → コンバージョン価値 = ¥125,000 ✓

**すべての数値は計算式と一致しています。**

## アップロードデータとの整合性確認方法

ブラウザの開発者ツール（F12）のコンソールで、以下のログを確認できます：

1. **`[AnomalyDetector] Target dates (12/16-18) detailed data`**
   - 12月16日、17日、18日の詳細データ（cost, conversions, CPAなど）

2. **`[AnomalyDetector] CPA Spike detected for 2024-12-XX`**
   - 各日の異常検知時の詳細情報
   - 過去5日間の平均CPA
   - その日のCPA
   - 増加率

これらのログで、アップロードされたデータと表示されている数値が一致しているか確認できます。

## 確認手順

1. ブラウザの開発者ツール（F12）を開く
2. コンソールタブを選択
3. AI異常検知モニターで「キャンペーンA」を選択
4. 日付範囲を「2024/12/01 ～ 2025/01/04」に設定
5. コンソールに表示されるログを確認：
   - `[AnomalyDetector] Target dates (12/16-18) detailed data` で各日のデータを確認
   - `[AnomalyDetector] CPA Spike detected for 2024-12-XX` で異常検知の詳細を確認




