# ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒ»ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ï¼‘ ãƒªãƒ¼ãƒãƒ‡ãƒ¼ã‚¿å–å¾—å•é¡Œ ä¿®æ­£æ¡ˆ

## å•é¡Œã®æ•´ç†

1. **æ—¥åˆ¥ã®ãƒªãƒ¼ãƒãƒ‡ãƒ¼ã‚¿ãŒã—ã£ã‹ã‚Šå–å¾—ã§ãã¦ã„ãªã„**
   - ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°
   - ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ï¼‘

2. **ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒªãƒ¼ãƒã‚‚ã—ã£ã‹ã‚Šã§ãã¦ã„ãªã„**
   - åŒã˜ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³

## åŸå› ã®ç‰¹å®š

### å•é¡Œ1: æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ä¸å®Œå…¨æ€§

**è€ƒãˆã‚‰ã‚Œã‚‹åŸå› **:
1. Meta APIã‹ã‚‰ã®æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒä¸å®Œå…¨
   - `time_increment=1`ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ãªã„å¯èƒ½æ€§
   - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ãŒä¸å®Œå…¨ãªå¯èƒ½æ€§
   - ç‰¹å®šã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã ã‘ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¦ã„ãªã„å¯èƒ½æ€§

2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¿å­˜ãŒä¸å®Œå…¨
   - æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãä¿å­˜ã•ã‚Œã¦ã„ãªã„
   - ãƒ‡ãƒ¼ã‚¿ã®é‡è¤‡ã‚„ä¸æ•´åˆ

### å•é¡Œ2: ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒªãƒ¼ãƒã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼

**è€ƒãˆã‚‰ã‚Œã‚‹åŸå› **:
1. ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã®ä¸ä¸€è‡´
   - Meta APIã‹ã‚‰å–å¾—ã—ãŸã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã¨ã€æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åãŒå®Œå…¨ã«ä¸€è‡´ã—ã¦ã„ãªã„
   - å…¨è§’ãƒ»åŠè§’ã®é•ã„ã€ã‚¹ãƒšãƒ¼ã‚¹ã®é•ã„ã€ç‰¹æ®Šæ–‡å­—ã®é•ã„

2. ãƒãƒƒãƒ”ãƒ³ã‚°ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°
   - æœŸé–“åˆ¥ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒªãƒ¼ãƒã®å–å¾—ãŒã€æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã®å‰ã«è¡Œã‚ã‚Œã¦ã„ã‚‹
   - ãƒãƒƒãƒ”ãƒ³ã‚°ãŒæ­£ã—ãè¡Œã‚ã‚Œã¦ã„ãªã„

## ä¿®æ­£æ¡ˆ

### ä¿®æ­£æ¡ˆ1: æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿å–å¾—ã®å¼·åŒ–ã¨æ¤œè¨¼

#### 1.1 Meta APIåŒæœŸå‡¦ç†ã®æ”¹å–„

**å ´æ‰€**: `backend/app/routers/meta_api.py`

**ä¿®æ­£å†…å®¹**:
1. **æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æ¤œè¨¼ã‚’å¼·åŒ–**
   - å„ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã”ã¨ã«å–å¾—ã—ãŸæ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã®ä»¶æ•°ã‚’ãƒ­ã‚°å‡ºåŠ›
   - æœŸå¾…ã•ã‚Œã‚‹æ—¥æ•°ã¨å®Ÿéš›ã«å–å¾—ã—ãŸæ—¥æ•°ã®å·®ã‚’æ¤œè¨¼
   - ç‰¹å®šã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã€ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ï¼‘ï¼‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’è©³ç´°ã«ãƒ­ã‚°å‡ºåŠ›

2. **ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã®æ”¹å–„**
   - ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ãŒæ­£ã—ãå–å¾—ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ”¹å–„

3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„**
   - ç‰¹å®šã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ãã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã ã‘ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç¶šè¡Œ
   - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®ãƒªã‚¹ãƒˆã‚’è¿”ã™

**ä¿®æ­£ã‚³ãƒ¼ãƒ‰ä¾‹**:
```python
# Line 305-350ä»˜è¿‘: æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æ¤œè¨¼ã‚’å¼·åŒ–
for idx, batch_item in enumerate(batch_data):
    campaign = batch_campaigns[idx]
    campaign_name = campaign.get('name', 'Unknown')
    campaign_id = campaign.get('id')
    
    if batch_item.get('code') == 200:
        try:
            item_body = json.loads(batch_item.get('body', '{}'))
            page_insights = item_body.get('data', [])
            
            if len(page_insights) > 0:
                all_insights.extend(page_insights)
                
                # ç‰¹å®šã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®å ´åˆã€è©³ç´°ãªãƒ­ã‚°ã‚’å‡ºåŠ›
                if 'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°' in campaign_name:
                    dates = [insight.get('date_start') for insight in page_insights if insight.get('date_start')]
                    unique_dates = sorted(list(set(dates)))
                    print(f"[Meta API] ğŸ” DEBUG: {campaign_name} - First page insights:")
                    print(f"  Total insights: {len(page_insights)}")
                    print(f"  Unique dates: {len(unique_dates)}")
                    print(f"  Date range: {unique_dates[0] if unique_dates else 'N/A'} to {unique_dates[-1] if unique_dates else 'N/A'}")
                    print(f"  Sample dates: {unique_dates[:10]}")
                
                # ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
                paging = item_body.get('paging', {})
                page_count = 1
                while 'next' in paging:
                    page_count += 1
                    next_url = paging['next']
                    print(f"[Meta API] Fetching page {page_count} for {campaign_name}...")
                    next_response = await client.get(next_url)
                    next_response.raise_for_status()
                    next_data = next_response.json()
                    next_insights = next_data.get('data', [])
                    all_insights.extend(next_insights)
                    paging = next_data.get('paging', {})
                    print(f"[Meta API] Retrieved {len(next_insights)} more insights for {campaign_name} (page {page_count}, total: {len(all_insights)})")
                    
                    # ç‰¹å®šã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®å ´åˆã€è©³ç´°ãªãƒ­ã‚°ã‚’å‡ºåŠ›
                    if 'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°' in campaign_name:
                        next_dates = [insight.get('date_start') for insight in next_insights if insight.get('date_start')]
                        next_unique_dates = sorted(list(set(next_dates)))
                        print(f"[Meta API] ğŸ” DEBUG: {campaign_name} - Page {page_count} insights:")
                        print(f"  Insights: {len(next_insights)}")
                        print(f"  Unique dates: {len(next_unique_dates)}")
                        print(f"  Sample dates: {next_unique_dates[:10]}")
                
                if page_count > 1:
                    print(f"[Meta API] Completed pagination for {campaign_name}: {page_count} pages, {len([i for i in all_insights if i.get('campaign_name') == campaign_name])} total insights")
                
                # ç‰¹å®šã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®å ´åˆã€æœ€çµ‚çš„ãªãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼
                if 'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°' in campaign_name:
                    campaign_insights = [i for i in all_insights if i.get('campaign_name') == campaign_name]
                    campaign_dates = [i.get('date_start') for i in campaign_insights if i.get('date_start')]
                    campaign_unique_dates = sorted(list(set(campaign_dates)))
                    print(f"[Meta API] ğŸ” DEBUG: {campaign_name} - Final data summary:")
                    print(f"  Total insights: {len(campaign_insights)}")
                    print(f"  Unique dates: {len(campaign_unique_dates)}")
                    print(f"  Date range: {campaign_unique_dates[0] if campaign_unique_dates else 'N/A'} to {campaign_unique_dates[-1] if campaign_unique_dates else 'N/A'}")
                    print(f"  All dates: {campaign_unique_dates}")
            else:
                if 'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°' in campaign_name:
                    print(f"[Meta API] âš ï¸ WARNING: No insights data returned for {campaign_name}")
                    print(f"[Meta API] Response body: {item_body}")
        except json.JSONDecodeError as e:
            print(f"[Meta API] Error parsing batch response for {campaign_name}: {str(e)}")
            if 'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°' in campaign_name:
                print(f"[Meta API] Response body: {batch_item.get('body', '{}')[:500]}")
```

#### 1.2 ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ™‚ã®æ¤œè¨¼ã‚’å¼·åŒ–

**å ´æ‰€**: `backend/app/routers/meta_api.py`

**ä¿®æ­£å†…å®¹**:
1. **ç‰¹å®šã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚’è©³ç´°ã«ãƒ­ã‚°å‡ºåŠ›**
   - ä¿å­˜ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰æ•°
   - ä¿å­˜ã•ã‚ŒãŸæ—¥ä»˜ã®ç¯„å›²
   - å„æ—¥ä»˜ã®ãƒªãƒ¼ãƒæ•°

**ä¿®æ­£ã‚³ãƒ¼ãƒ‰ä¾‹**:
```python
# Line 875-1220ä»˜è¿‘: ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ™‚ã®æ¤œè¨¼ã‚’å¼·åŒ–
saved_count = 0
hybrid_marketing_records = []  # ãƒ‡ãƒãƒƒã‚°ç”¨

for insight in all_insights:
    try:
        # ... æ—¢å­˜ã®å‡¦ç† ...
        
        # ç‰¹å®šã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®å ´åˆã€è©³ç´°ãªãƒ­ã‚°ã‚’å‡ºåŠ›
        if 'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°' in campaign_name:
            hybrid_marketing_records.append({
                'campaign_name': campaign_name,
                'date': campaign_date,
                'reach': reach,
                'period_unique_reach_all': period_unique_reach_all
            })
        
        db.add(campaign)
        saved_count += 1
        
    except Exception as e:
        print(f"[Meta API] Error processing insight: {str(e)}")
        if 'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°' in campaign_name:
            print(f"[Meta API] Failed insight: {insight}")
        continue

# ç‰¹å®šã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜çµæœã‚’ãƒ­ã‚°å‡ºåŠ›
if hybrid_marketing_records:
    print(f"[Meta API] ğŸ” DEBUG: Hybrid Marketing records saved:")
    print(f"  Total records: {len(hybrid_marketing_records)}")
    dates = sorted(set([r['date'] for r in hybrid_marketing_records]))
    print(f"  Date range: {dates[0] if dates else 'N/A'} to {dates[-1] if dates else 'N/A'}")
    print(f"  Unique dates: {len(dates)}")
    for record in hybrid_marketing_records[:10]:
        print(f"    {record['date']}: reach={record['reach']}, period_unique_reach_all={record['period_unique_reach_all']}")
```

### ä¿®æ­£æ¡ˆ2: ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒªãƒ¼ãƒã®ãƒãƒƒãƒ”ãƒ³ã‚°æ”¹å–„

#### 2.1 ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã®æ­£è¦åŒ–

**å ´æ‰€**: `backend/app/routers/meta_api.py`

**ä¿®æ­£å†…å®¹**:
1. **ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã®æ­£è¦åŒ–é–¢æ•°ã‚’è¿½åŠ **
   - å…¨è§’ãƒ»åŠè§’ã®çµ±ä¸€
   - ã‚¹ãƒšãƒ¼ã‚¹ã®çµ±ä¸€
   - ç‰¹æ®Šæ–‡å­—ã®å‡¦ç†

**ä¿®æ­£ã‚³ãƒ¼ãƒ‰ä¾‹**:
```python
# ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«è¿½åŠ 
def normalize_campaign_name(name: str) -> str:
    """
    ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã‚’æ­£è¦åŒ–ï¼ˆå…¨è§’ãƒ»åŠè§’ã®çµ±ä¸€ã€ã‚¹ãƒšãƒ¼ã‚¹ã®çµ±ä¸€ãªã©ï¼‰
    """
    if not name:
        return ''
    # å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã«å¤‰æ›
    name = name.replace('ã€€', ' ')
    # é€£ç¶šã™ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«çµ±ä¸€
    import re
    name = re.sub(r'\s+', ' ', name)
    # å‰å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤
    name = name.strip()
    return name

# Line 1155-1174ä»˜è¿‘: ãƒãƒƒãƒ”ãƒ³ã‚°æ™‚ã«æ­£è¦åŒ–ã‚’ä½¿ç”¨
if not ad_set_name and not ad_name:  # ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ¬ãƒ™ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
    # ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã‚’æ­£è¦åŒ–
    normalized_campaign_name = normalize_campaign_name(campaign_name)
    
    # æœŸé–“åˆ¥ã®ãƒãƒƒãƒ—ã‹ã‚‰å–å¾—ï¼ˆæ­£è¦åŒ–ã•ã‚ŒãŸåå‰ã§æ¤œç´¢ï¼‰
    try:
        # ã¾ãšæ­£è¦åŒ–ã•ã‚ŒãŸåå‰ã§æ¤œç´¢
        period_unique_reach_7days = campaign_period_reach_7days_map.get(normalized_campaign_name, 0)
        period_unique_reach_30days = campaign_period_reach_30days_map.get(normalized_campaign_name, 0)
        period_unique_reach_all = campaign_period_reach_all_map.get(normalized_campaign_name, 0)
        
        # è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€å…ƒã®åå‰ã§æ¤œç´¢ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        if period_unique_reach_all == 0:
            period_unique_reach_7days = campaign_period_reach_7days_map.get(campaign_name, 0)
            period_unique_reach_30days = campaign_period_reach_30days_map.get(campaign_name, 0)
            period_unique_reach_all = campaign_period_reach_all_map.get(campaign_name, 0)
        
        # ã¾ã è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€å…¨æœŸé–“ã®ãƒãƒƒãƒ—ã‹ã‚‰å–å¾—
        if period_unique_reach_all == 0:
            period_unique_reach_all = campaign_period_reach_map.get(normalized_campaign_name, 0)
            if period_unique_reach_all == 0:
                period_unique_reach_all = campaign_period_reach_map.get(campaign_name, 0)
    except:
        # ãƒãƒƒãƒ—ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€å…¨æœŸé–“ã®ãƒãƒƒãƒ—ã‹ã‚‰å–å¾—
        period_unique_reach_all = campaign_period_reach_map.get(normalized_campaign_name, 0)
        if period_unique_reach_all == 0:
            period_unique_reach_all = campaign_period_reach_map.get(campaign_name, 0)
    
    # ç‰¹å®šã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®å ´åˆã€ãƒãƒƒãƒ”ãƒ³ã‚°çµæœã‚’ãƒ­ã‚°å‡ºåŠ›
    if 'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°' in campaign_name:
        print(f"[Meta API] ğŸ” DEBUG: Unique reach mapping for '{campaign_name}':")
        print(f"  Normalized name: '{normalized_campaign_name}'")
        print(f"  period_unique_reach_7days: {period_unique_reach_7days}")
        print(f"  period_unique_reach_30days: {period_unique_reach_30days}")
        print(f"  period_unique_reach_all: {period_unique_reach_all}")
        print(f"  Available keys in map: {[k for k in campaign_period_reach_all_map.keys() if 'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°' in k]}")
```

#### 2.2 æœŸé–“åˆ¥ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒªãƒ¼ãƒå–å¾—æ™‚ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã®æ­£è¦åŒ–

**å ´æ‰€**: `backend/app/routers/meta_api.py`

**ä¿®æ­£å†…å®¹**:
1. **æœŸé–“åˆ¥ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒªãƒ¼ãƒå–å¾—æ™‚ã«ã‚‚ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã‚’æ­£è¦åŒ–**
   - ãƒãƒƒãƒ—ã«ä¿å­˜ã™ã‚‹éš›ã«æ­£è¦åŒ–ã•ã‚ŒãŸåå‰ã‚’ä½¿ç”¨
   - æ¤œç´¢æ™‚ã«ã‚‚æ­£è¦åŒ–ã•ã‚ŒãŸåå‰ã‚’ä½¿ç”¨

**ä¿®æ­£ã‚³ãƒ¼ãƒ‰ä¾‹**:
```python
# Line 470-475ä»˜è¿‘: æœŸé–“åˆ¥ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒªãƒ¼ãƒå–å¾—æ™‚ã«æ­£è¦åŒ–
if len(period_insights) > 0:
    insight_data = period_insights[0]
    period_reach = safe_int(insight_data.get('reach'), 0)
    
    # ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã‚’æ­£è¦åŒ–
    normalized_campaign_name = normalize_campaign_name(campaign_name)
    period_map[normalized_campaign_name] = period_reach
    
    # å…ƒã®åå‰ã§ã‚‚ä¿å­˜ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
    if normalized_campaign_name != campaign_name:
        period_map[campaign_name] = period_reach
    
    print(f"[Meta API] {period_name} unique reach for {campaign_name} (normalized: {normalized_campaign_name}): {period_reach:,}")
```

### ä¿®æ­£æ¡ˆ3: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ¤œè¨¼ã¨ä¿®æ­£

#### 3.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

**å ´æ‰€**: `backend/app/routers/campaigns.py`

**ä¿®æ­£å†…å®¹**:
1. **ç‰¹å®šã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’è©³ç´°ã«ç¢ºèªã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ **

**ä¿®æ­£ã‚³ãƒ¼ãƒ‰ä¾‹**:
```python
@router.get("/debug/campaign-detail")
def debug_campaign_detail(
    campaign_name: str = Query(..., description="ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å"),
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """
    ç‰¹å®šã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’è©³ç´°ã«ç¢ºèª
    """
    try:
        # ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ¬ãƒ™ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å–å¾—
        campaigns = db.query(Campaign).filter(
            Campaign.user_id == current_user.id,
            Campaign.campaign_name == campaign_name,
            or_(Campaign.ad_set_name == '', Campaign.ad_set_name.is_(None)),
            or_(Campaign.ad_name == '', Campaign.ad_name.is_(None))
        ).order_by(Campaign.date).all()
        
        if len(campaigns) == 0:
            return {
                "message": "ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚",
                "campaign_name": campaign_name,
                "records": []
            }
        
        # æ—¥ä»˜ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
        records_by_date = {}
        for c in campaigns:
            date_str = str(c.date)
            if date_str not in records_by_date:
                records_by_date[date_str] = {
                    "date": date_str,
                    "reach": 0,
                    "period_unique_reach_all": c.period_unique_reach_all or 0,
                    "period_unique_reach_30days": c.period_unique_reach_30days or 0,
                    "period_unique_reach_7days": c.period_unique_reach_7days or 0,
                    "period_unique_reach": c.period_unique_reach or 0,
                    "record_count": 0
                }
            records_by_date[date_str]["reach"] += c.reach or 0
            records_by_date[date_str]["record_count"] += 1
        
        records = sorted(records_by_date.values(), key=lambda x: x["date"])
        
        # çµ±è¨ˆæƒ…å ±
        total_reach = sum(r["reach"] for r in records)
        unique_dates = len(records)
        period_unique_reach_all = records[0]["period_unique_reach_all"] if records else 0
        
        return {
            "message": "ç¢ºèªå®Œäº†",
            "campaign_name": campaign_name,
            "total_records": len(campaigns),
            "unique_dates": unique_dates,
            "total_reach": total_reach,
            "period_unique_reach_all": period_unique_reach_all,
            "date_range": {
                "start": records[0]["date"] if records else None,
                "end": records[-1]["date"] if records else None
            },
            "records": records
        }
    except Exception as e:
        import traceback
        logger.error(f"[Debug Campaign Detail] Error: {str(e)}")
        logger.error(traceback.format_exc())
        raise HTTPException(
            status_code=500,
            detail=f"ç¢ºèªã‚¨ãƒ©ãƒ¼: {str(e)}"
        )
```

## ä¿®æ­£ã®å„ªå…ˆé †ä½

1. **æœ€å„ªå…ˆ**: ä¿®æ­£æ¡ˆ1.1ï¼ˆæ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æ¤œè¨¼ã‚’å¼·åŒ–ï¼‰
   - å•é¡Œã®æ ¹æœ¬åŸå› ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«å¿…è¦

2. **é«˜**: ä¿®æ­£æ¡ˆ2.1ï¼ˆã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã®æ­£è¦åŒ–ï¼‰
   - ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒªãƒ¼ãƒã®ãƒãƒƒãƒ”ãƒ³ã‚°å•é¡Œã‚’è§£æ±º

3. **ä¸­**: ä¿®æ­£æ¡ˆ1.2ï¼ˆãƒ‡ãƒ¼ã‚¿ä¿å­˜æ™‚ã®æ¤œè¨¼ã‚’å¼·åŒ–ï¼‰
   - ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãŒæ­£ã—ãè¡Œã‚ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

4. **ä½**: ä¿®æ­£æ¡ˆ3.1ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ¤œè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
   - ãƒ‡ãƒãƒƒã‚°ç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

## å®Ÿè£…æ‰‹é †

1. **ä¿®æ­£æ¡ˆ1.1ã‚’å®Ÿè£…**
   - æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æ¤œè¨¼ã‚’å¼·åŒ–
   - ç‰¹å®šã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’è©³ç´°ã«ãƒ­ã‚°å‡ºåŠ›

2. **Meta APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—**
   - ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
   - ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦å•é¡Œã‚’ç‰¹å®š

3. **ä¿®æ­£æ¡ˆ2.1ã‚’å®Ÿè£…**
   - ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã®æ­£è¦åŒ–ã‚’å®Ÿè£…
   - ãƒãƒƒãƒ”ãƒ³ã‚°å‡¦ç†ã‚’æ”¹å–„

4. **å†åº¦ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—**
   - ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
   - å•é¡ŒãŒè§£æ±ºã—ãŸã‹ç¢ºèª

5. **ä¿®æ­£æ¡ˆ1.2ã¨3.1ã‚’å®Ÿè£…ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰**
   - ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ™‚ã®æ¤œè¨¼ã‚’å¼·åŒ–
   - ãƒ‡ãƒãƒƒã‚°ç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ 

