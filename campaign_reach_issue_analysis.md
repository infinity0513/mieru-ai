# ハイブリッドマーケティング・ハイブリッドマーケティング１のリーチ数取得問題の分析

## 問題の概要

「ハイブリッドマーケティング」と「ハイブリッドマーケティング１」のリーチ数が正しく取得できていない。

## 調査結果

### 1. キャンペーン名の正規化処理

**場所**: `meta_api.py` Line 22-35

**現在の実装**:
```python
def normalize_campaign_name(name: str) -> str:
    """
    キャンペーン名を正規化（前後のスペース削除、全角・半角の統一）
    """
    if not name:
        return ''
    # 全角スペースを半角スペースに変換
    name = name.replace('　', ' ')
    # 連続するスペースを1つに統一
    import re
    name = re.sub(r'\s+', ' ', name)
    # 前後のスペースを削除
    name = name.strip()
    return name
```

**問題点**:
- 正規化処理は実装されているが、**データベースに保存する際のキャンペーン名が正規化されていない可能性がある**

### 2. 期間別ユニークリーチのマッピング処理

**場所**: `meta_api.py` Line 508-513, 823-828

**現在の実装**:
```python
# 期間別ユニークリーチ取得時
normalized_campaign_name = normalize_campaign_name(campaign_name)
period_map[normalized_campaign_name] = period_reach
```

**問題点**:
- 期間別ユニークリーチを取得する際、**正規化されたキャンペーン名でマップに保存**している
- しかし、**データベースに保存する際のキャンペーン名が正規化されていない**場合、マップから取得できない

### 3. データベースへの保存処理

**場所**: `meta_api.py` Line 933, 1000-1050

**現在の実装**:
```python
# 日次データ取得時
campaign_name = insight.get('campaign_name', 'Unknown')
# ... データベースに保存
```

**問題点**:
- 日次データ取得時、**Meta APIから取得したキャンペーン名をそのままデータベースに保存**している
- **正規化処理が適用されていない**可能性がある

### 4. マップからの取得処理

**場所**: `meta_api.py` Line 948-975, 1222-1249

**現在の実装**:
```python
# データベースに保存する際
normalized_campaign_name = normalize_campaign_name(campaign_name)
period_unique_reach_all = campaign_period_reach_all_map.get(normalized_campaign_name, 0)

# 正規化前の名前でも試す（後方互換性のため）
if period_unique_reach_all == 0:
    period_unique_reach_all = campaign_period_reach_all_map.get(campaign_name, 0)
```

**問題点**:
- マップから取得する際、**正規化されたキャンペーン名で検索**している
- しかし、**データベースに保存されているキャンペーン名が正規化されていない**場合、マッチしない
- 後方互換性のため、正規化前の名前でも試しているが、**期間別ユニークリーチ取得時のキャンペーン名と日次データ取得時のキャンペーン名が異なる**場合、マッチしない

## 考えられる問題

### 問題1: データベースへの保存時のキャンペーン名が正規化されていない

**原因**:
- 日次データ取得時（Line 933）、Meta APIから取得したキャンペーン名をそのままデータベースに保存している
- 期間別ユニークリーチ取得時（Line 508, 823）、正規化されたキャンペーン名でマップに保存している
- **データベースに保存されているキャンペーン名と、マップに保存されているキャンペーン名が一致しない**

**影響**:
- マップから期間別ユニークリーチを取得する際、正規化されたキャンペーン名で検索するが、データベースに保存されているキャンペーン名が正規化されていない場合、マッチしない
- 後方互換性のため、正規化前の名前でも試しているが、期間別ユニークリーチ取得時のキャンペーン名と日次データ取得時のキャンペーン名が異なる場合、マッチしない

### 問題2: Meta APIから取得したキャンペーン名の不一致

**原因**:
- 日次データ取得時と期間別ユニークリーチ取得時で、Meta APIから取得したキャンペーン名が異なる可能性がある
- 例: 日次データ取得時は「ハイブリッドマーケティング」、期間別ユニークリーチ取得時は「ハイブリッド マーケティング」（スペースが異なる）

**影響**:
- 正規化処理を適用しても、元のキャンペーン名が異なる場合、マッチしない

### 問題3: キャンペーン名の正規化処理が不十分

**原因**:
- 現在の正規化処理は、スペースの統一と前後のスペース削除のみ
- **全角・半角文字の統一が行われていない**（例: 「ハイブリッドマーケティング」と「ハイブリッドマーケティング」）
- **特殊文字の処理が行われていない**（例: 「ハイブリッドマーケティング１」と「ハイブリッドマーケティング1」）

**影響**:
- 全角・半角文字が混在している場合、正規化処理を適用してもマッチしない

### 問題4: データベースへの保存時のキャンペーン名の正規化

**原因**:
- データベースに保存する際、キャンペーン名を正規化していない
- 期間別ユニークリーチ取得時は正規化されたキャンペーン名でマップに保存しているが、データベースに保存されているキャンペーン名が正規化されていない場合、マッチしない

**影響**:
- マップから期間別ユニークリーチを取得する際、正規化されたキャンペーン名で検索するが、データベースに保存されているキャンペーン名が正規化されていない場合、マッチしない

## 確認すべき点

### 1. データベースに保存されているキャンペーン名の確認

**確認方法**:
- データベースから「ハイブリッドマーケティング」と「ハイブリッドマーケティング１」のキャンペーン名を取得
- 正規化処理を適用した結果と比較
- スペース、全角・半角文字、特殊文字の有無を確認

### 2. Meta APIから取得したキャンペーン名の確認

**確認方法**:
- 日次データ取得時と期間別ユニークリーチ取得時で、Meta APIから取得したキャンペーン名を比較
- ログから確認（Line 515-523, 830-836）

### 3. マップに保存されているキャンペーン名の確認

**確認方法**:
- 期間別ユニークリーチ取得時、マップに保存されているキャンペーン名を確認
- ログから確認（Line 512-513, 827-828）

### 4. マップからの取得処理の確認

**確認方法**:
- データベースに保存する際、マップから期間別ユニークリーチを取得する処理を確認
- 正規化されたキャンペーン名で検索しているが、マッチしない場合のログを確認（Line 954-959, 1228-1233）

## 修正案（まだ修正しない）

### 修正案1: データベースへの保存時のキャンペーン名を正規化

**場所**: `meta_api.py` Line 933, 1000-1050

**修正内容**:
- データベースに保存する際、キャンペーン名を正規化してから保存
- これにより、期間別ユニークリーチ取得時のキャンペーン名と一致する

### 修正案2: キャンペーン名の正規化処理を強化

**場所**: `meta_api.py` Line 22-35

**修正内容**:
- 全角・半角文字の統一（例: 「１」→「1」）
- 特殊文字の処理（例: 「ハイブリッドマーケティング１」→「ハイブリッドマーケティング1」）

### 修正案3: マップからの取得処理を改善

**場所**: `meta_api.py` Line 948-975, 1222-1249

**修正内容**:
- データベースに保存されているキャンペーン名を正規化してからマップから取得
- 正規化前の名前でも試す処理を維持（後方互換性のため）

### 修正案4: デバッグログの追加

**場所**: `meta_api.py` Line 948-975, 1222-1249

**修正内容**:
- マップから期間別ユニークリーチを取得する際、キャンペーン名の正規化前後の値をログ出力
- マッチしない場合の詳細なログを出力

## 結論

**主な問題は、データベースに保存されているキャンペーン名と、マップに保存されているキャンペーン名が一致しないことです。**

- 期間別ユニークリーチ取得時は正規化されたキャンペーン名でマップに保存
- データベースに保存する際は正規化されていないキャンペーン名で保存
- マップから取得する際は正規化されたキャンペーン名で検索するが、データベースに保存されているキャンペーン名が正規化されていない場合、マッチしない

修正案1を実装することで、この問題を解決できます。

