# 特定のキャンペーンだけ数字が合わない原因分析

## 質問
「他のキャンペーンは数字があっていて、特定のキャンペーンだけ数字が合わない。こんなことあるのか？」

## 回答
**はい、あり得ます。** 特定のキャンペーンだけ数字が合わない原因として、以下の可能性があります。

## 考えられる原因

### 1. キャンペーン名の不一致によるマッピングエラー（最も可能性が高い）

#### 問題のメカニズム
1. **Meta APIからのユニークリーチ取得時**（`meta_api.py` Line 474, 779）
   ```python
   period_map[campaign_name] = period_reach
   ```
   - Meta APIから取得したキャンペーン名（例: `"ハイブリッドマーケティング"`）でマップに保存

2. **日次データ保存時のマッピング**（`meta_api.py` Line 1158-1160）
   ```python
   period_unique_reach_7days = campaign_period_reach_7days_map.get(campaign_name, 0)
   period_unique_reach_30days = campaign_period_reach_30days_map.get(campaign_name, 0)
   period_unique_reach_all = campaign_period_reach_all_map.get(campaign_name, 0)
   ```
   - 日次データの`campaign_name`（例: `"ハイブリッドマーケティング "`（末尾にスペース））でマップから取得
   - **完全一致で検索するため、不一致の場合は0が返される**

#### キャンペーン名の不一致が発生するケース
- **全角・半角の違い**: `"ハイブリッドマーケティング"` vs `"ハイブリッドマーケティング"`（全角スペース）
- **前後のスペース**: `"ハイブリッドマーケティング"` vs `" ハイブリッドマーケティング "`
- **特殊文字のエンコーディング**: URLを含むキャンペーン名（`http://infinity111.net/ea/toshinavi/`）の場合、エンコーディングの違い
- **Meta APIとデータベースでの保存時の違い**: Meta APIから取得した名前と、データベースに保存された名前が微妙に異なる

#### 影響
- ユニークリーチが0になる
- 日次データは正しく取得・保存されているが、ユニークリーチがマッピングされない
- 結果として、リーチ数（全体）は正しいが、リーチ数（ユニーク）が0または間違った値になる

### 2. Meta APIからの日次データ取得の不完全性

#### 問題のメカニズム
- 特定のキャンペーンだけ、Meta APIからの日次データ取得が不完全
- ページネーション処理が特定のキャンペーンで失敗している
- `time_increment=1`が特定のキャンペーンで正しく動作していない

#### 影響
- 日次データが一部欠落
- リーチ数（全体）の合計が正しくない
- 特定の日付のデータが取得できていない

### 3. データベースへの保存時の問題

#### 問題のメカニズム
- 特定のキャンペーンのデータだけ、データベースへの保存が失敗している
- 重複チェック（`seen_records`）により、特定のキャンペーンのデータがスキップされている
- トランザクションエラーにより、特定のキャンペーンのデータだけ保存されていない

#### 影響
- データベースにデータが存在しない、または不完全
- フロントエンドでデータが取得できない

### 4. フロントエンドでのフィルタリングの問題

#### 問題のメカニズム
- フロントエンドでは`d.campaign_name === campaignNameParam`で完全一致でフィルタリング（`Dashboard.tsx` Line 2250）
- キャンペーン名に微妙な違いがあると、フィルタリングで除外される

#### 影響
- データが存在するが、フィルタリングで除外される
- 表示されるデータが0件になる

### 5. バックエンドでのフィルタリングの不一致

#### 問題のメカニズム
- `campaigns.py`のLine 668では`ilike`を使用（部分一致）
- しかし、Line 42, 889などでは`==`を使用（完全一致）
- この不一致により、特定のキャンペーンだけデータが取得できない

#### 影響
- APIからデータが返されない
- フロントエンドでデータが表示されない

## 最も可能性が高い原因

**キャンペーン名の不一致によるマッピングエラー**が最も可能性が高いです。

### 理由
1. **他のキャンペーンは正しく動作している**
   - データ取得・保存ロジック自体は問題ない
   - 特定のキャンペーンだけ問題がある

2. **ユニークリーチのマッピングが完全一致で行われている**
   - `campaign_period_reach_all_map.get(campaign_name, 0)`
   - キャンペーン名が1文字でも違うと、マッピングが失敗する

3. **URLを含むキャンペーン名の場合、エンコーディングの問題が発生しやすい**
   - `http://infinity111.net/ea/toshinavi/`のようなURLを含むキャンペーン名
   - Meta APIから取得した名前と、データベースに保存された名前が微妙に異なる可能性

## 確認方法

### 1. データベースの実際のデータを確認
```sql
-- 特定のキャンペーンのデータを確認
SELECT 
    campaign_name,
    date,
    reach,
    period_unique_reach_all,
    period_unique_reach_30days,
    period_unique_reach_7days,
    period_unique_reach
FROM campaigns
WHERE campaign_name LIKE '%toshinavi%' OR campaign_name LIKE '%ハイブリッドマーケティング%'
ORDER BY campaign_name, date;
```

### 2. Meta API同期処理のログを確認
- 期間別ユニークリーチ取得時のキャンペーン名
- 日次データ保存時のキャンペーン名
- マッピング時のキャンペーン名

### 3. フロントエンドでのフィルタリングを確認
- ブラウザのコンソールで、フィルタリング前後のデータ数を確認
- キャンペーン名の完全一致を確認

## 結論

**はい、特定のキャンペーンだけ数字が合わないことはあり得ます。**

主な原因は：
1. **キャンペーン名の不一致によるマッピングエラー**（最も可能性が高い）
2. Meta APIからの日次データ取得の不完全性
3. データベースへの保存時の問題
4. フロントエンド/バックエンドでのフィルタリングの問題

特に、URLを含むキャンペーン名（`http://infinity111.net/ea/toshinavi/`）や、特殊文字を含むキャンペーン名の場合、エンコーディングや正規化の問題により、キャンペーン名の不一致が発生しやすいです。

